[platformio]
default_envs = pico32, pico32-ota

[env:pico32]
platform = espressif32
board = pico32
framework = arduino

; Serial Monitor options
monitor_speed = 115200

; Skip tests for pico32 (tests are designed for native environment only)
test_ignore = *

; Partition scheme - use more of the 4MB flash (3MB app space)
board_build.partitions = huge_app.csv

; Pre-build script to generate version information
extra_scripts = pre:scripts/generate_version_prebuild.py

; Build options
; Feature flags for upload backends (enable only what you need to reduce binary size)
; 
; UPLOAD BACKEND SELECTION:
; Uncomment the appropriate flag(s) for your desired upload method(s).
; Only one backend is typically needed, but multiple can be enabled if you want
; to switch between them at runtime via config.txt ENDPOINT_TYPE setting.
;
; Available backends:
;   - SMB/CIFS: Upload to Windows shares, NAS devices, or Samba servers
;   - WebDAV: Upload to Nextcloud, ownCloud, or WebDAV servers (TODO: not yet implemented)
;   - Cloud/SleepHQ: Direct upload to SleepHQ cloud service via REST API
;
; Binary size impact (approximate):
;   - SMB: +220-270KB (includes libsmb2 library)
;   - WebDAV: +50-80KB (estimated, uses HTTPClient)
;   - SleepHQ: +40-60KB (estimated, uses HTTPClient + JSON)
;
; To use SMB upload:
;   1. Uncomment -DENABLE_SMB_UPLOAD below
;   2. Run setup script: ./setup.sh (automatically clones libsmb2)
;   3. Set ENDPOINT_TYPE="SMB" in config.txt
;
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -Icomponents/libsmb2/include
    -DENABLE_SMB_UPLOAD          ; Enable SMB/CIFS upload support
    ; -DENABLE_WEBDAV_UPLOAD     ; Enable WebDAV upload support (TODO: not yet implemented)
    -DENABLE_SLEEPHQ_UPLOAD      ; Enable Cloud/SleepHQ upload support (uses HTTPS + OAuth)
    -DENABLE_TEST_WEBSERVER      ; Enable test web server for on-demand upload testing
    ; -DENABLE_CPAP_MONITOR      ; Enable CPAP SD card usage monitoring (disabled by default due to CS_SENSE HW issue)
    ; -DENABLE_VERBOSE_LOGGING   ; Uncomment to enable debug logs (adds ~7KB flash, detailed diagnostics)
    
    ; LOGGING CONFIGURATION:
    ; Configure the circular buffer size for the logging system (default: 2048 bytes = 2KB)
    ; The buffer stores recent logs in RAM for retrieval via web API
    ; Larger buffers retain more history but use more RAM
    ; Examples:
    ;   -DLOG_BUFFER_SIZE=1024   ; 1KB buffer (minimal memory usage)
    ;   -DLOG_BUFFER_SIZE=4096   ; 4KB buffer (more log history)
    ;   -DLOG_BUFFER_SIZE=12288  ; ~12KB buffer (~100 lines typical)
    -DLOG_BUFFER_SIZE=12288    ; Reduced RAM footprint while retaining useful recent history
    
    ; STACK SIZE CONFIGURATION:
    ; Increase loop task stack size to handle credential migration (default: 8192 bytes)
    ; The migration process uses two 4KB JSON documents on the stack
    -DARDUINO_LOOP_STACK_SIZE=16384  ; 16KB stack for loop task

; Library dependencies
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

; Extra library directories
lib_extra_dirs = components

; Note: MD5 checksums use ESP32 ROM functions (esp32/rom/md5_hash.h)
; instead of mbedtls to avoid linking issues

; Note: libsmb2 is automatically set up by ./setup.sh script
; The library will be automatically included as an ESP-IDF component

; Upload options
upload_speed = 115200

; ============================================================================
; OTA-ENABLED BUILD TARGET
; ============================================================================
; This target includes Over-The-Air update functionality via web interface
; - Smaller app partitions (1.5MB each) to accommodate OTA
; - Web-based firmware update capability
; - Automatic restart after updates
; - Use this for production deployments where remote updates are needed
;
[env:pico32-ota]
platform = espressif32
board = pico32
framework = arduino

; Serial Monitor options
monitor_speed = 115200
test_ignore = *

; OTA partition scheme - 2x 1.5MB app partitions
board_build.partitions = partitions_ota.csv

; Pre-build script to generate version information
extra_scripts = pre:scripts/generate_version_prebuild.py

; Build flags - same as base + OTA support
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -Icomponents/libsmb2/include
    -DENABLE_SMB_UPLOAD          ; Enable SMB/CIFS upload support
    -DENABLE_SLEEPHQ_UPLOAD      ; Enable Cloud/SleepHQ upload support (uses HTTPS + OAuth)
    -DENABLE_TEST_WEBSERVER      ; Enable test web server for on-demand upload testing
    -DENABLE_OTA_UPDATES         ; Enable Over-The-Air update functionality
    -DLOG_BUFFER_SIZE=12288      ; ~12KB buffer (~100 lines typical)
    -DARDUINO_LOOP_STACK_SIZE=16384  ; 16KB stack for loop task (credential migration needs extra space)

; Library dependencies - same as base + OTA libraries
lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

lib_extra_dirs = components
upload_speed = 115200

; Native testing environment
[env:native]
platform = native
build_flags = 
    -DUNIT_TEST
    -std=c++11
    -I include
    -I test/mocks
test_framework = unity
test_build_src = yes
; Exclude ESP32-specific source files from native build
; Tests will include only the specific components they need
build_src_filter = 
    -<*>
